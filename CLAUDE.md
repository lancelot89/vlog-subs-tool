# CLAUDE.md — ClaudeCode用実装ルール（字幕OCR翻訳アプリ）

このドキュメントは、ClaudeCode が字幕OCR翻訳アプリを開発するにあたって遵守すべき実装方針と設計ルールを定めたものです。

---

## 🎯 プロジェクト概要（要約）
- 音声のないVLOG動画に焼き付けられた日本語字幕（ハードサブ）を、OCRで自動抽出し、GUI上で編集・確認・翻訳できる非エンジニア向けアプリケーションを作成する。
- 対応プラットフォームは **macOS / Windows / Linux**。
- 最終的に **多言語SRTファイルを生成してYouTubeにアップできる**ことを目的とする。

---

## 🔧 技術スタック（必須）
| 機能             | 採用技術            |
|------------------|---------------------|
| GUI              | PySide6 (Qt for Python) |
| 映像処理         | OpenCV + ffmpeg     |
| OCR              | PaddleOCR（既定）、Tesseract（オプション） |
| 翻訳             | Google Cloud Translation v3 / DeepL / CSVエクスポート対応 |
| パッケージング   | PyInstaller         |

---

## 🧭 作業時のルール（Gitブランチ／PR運用）

### 🔄 **標準開発フロー（必須遵守）**
ClaudeCodeは以下の順序で作業を行うこと：

1. **📝 Issue作成**
   - 問題・機能・改善点を必ずIssueとして先に登録
   - タイトルは具体的で理解しやすく（例: 「Windows実行時にPaddleX .versionファイルが見つからない」）
   - 以下の項目を含める：
     - 問題の概要/期待する機能
     - 原因分析（バグの場合）
     - 受け入れ条件（チェックリスト形式）
     - Priority（Critical/High/Medium/Low）
     - 適切なLabels（bug/feature/enhancement など）

2. **🌿 ブランチ作成**
   - **⚠️ 必須**: 新しいブランチは**必ず最新のmainブランチから作成**すること
     - 作業開始前に `git checkout main && git pull origin main` を実行
     - その後 `git checkout -b {ブランチ名}` でブランチ作成
   - Issueに対応する新しいブランチを作成
   - 命名規則: `{type}/{issue-number}-{short-description}`
     - 例: `fix/47-paddlex-version-file`, `feat/48-translation-ui`

3. **🔧 実装・修正作業**
   - 作業内容はIssueの受け入れ条件に沿って実施
   - コミットメッセージは意味のある単位で分割

4. **📤 PR作成**
   - **必ず「Closes #XX」でIssueを紐づける**
   - PRテンプレートに従って詳細な説明を記載

### ✅ ブランチ運用ポリシー
- `main` ブランチは **常に安定した状態**を保つこと。
- すべての変更は **新しいブランチを作成して作業**すること。
  - 命名例：
    - `fix/47-paddlex-version-file`
    - `feat/48-translation-tab-ui`
    - `refactor/49-subtitle-merger`
    - `feature/50-p1-core-implementation`
- **main へ直接 push することは禁止**。
- **⚠️ 必須**: 新しいブランチは**必ず最新のmainブランチから作成**すること。
  - 古いブランチから新しいブランチを作成することは禁止。
  - 作業前に必ず `git checkout main && git pull origin main` で最新化。
- 機能単位・目的ごとに小さなブランチを分けること。
- **⚠️ 重要**: ClaudeCodeは修正作業を開始する前に**必ずIssue作成→mainブランチ最新化→ブランチ作成**の順序を遵守すること。

### ✅ プルリクエスト（PR）運用ルール
- PRは **意味のある単位で細かく作成**すること。
- **⚠️ 必須**: **1 Issue = 1 PR** で作成する。複数のIssueを含むPRは禁止。
- PRには以下の情報を含める：
  - **解決するIssue番号**（先頭に `Closes #XX` を記載）
  - **変更概要（What）**
  - **背景・目的（Why）**
  - **動作確認内容（How）**
  - **影響範囲（UI、入出力ファイルなど）**
- 作業中のPRは **Draft PR として提出**し、完成後にレビュー依頼。
- **破壊的変更を含むPRは、必ずレビューを受けてからマージすること**。
- **⚠️ 必須**: **実装完了後は必ずPRを作成すること**。実装 → コミット → プッシュ → PR作成までを1セットとする。

### ✅ コミットルール（semantic commit）
| prefix | 意味 |
|--------|------|
| `feat:` | 新機能追加 |
| `fix:` | バグ修正 |
| `refactor:` | 内部リファクタリング |
| `docs:` | ドキュメント変更 |
| `test:` | テストコード追加・修正 |
| `chore:` | ビルド、依存関係、CI構成など |

- コミットは **1つの目的＝1コミット** を基本とする。
- 自動生成されたコードでも、手動で意味のあるメッセージにすること。

---

## 🛑 破壊的変更の回避ルール

### ✅ 入出力形式（SRT, CSV, JSONなど）
- フォーマット変更は **破壊的変更**とみなす。
- 変更時は以下を徹底：
  - **Issueを立てて議論の上、承認された場合のみブランチ作成**。
  - PRの説明に「**互換性の影響とその対処法**」を明示。
  - 必要であれば、旧形式との**後方互換機能を一時的に保持**。

### ✅ 初期設定・パラメータ
- デフォルト値（例: FPS, 行長, 最小表示秒, 翻訳言語など）を変更する場合は、
  - **明示的にユーザーが設定画面から変更可能な設計にすること**
  - ハードコードや強制変更を避けること

### ✅ モジュール名・関数名の変更
- 外部から参照されている関数名・クラス名を変更する際は、
  - **コード全体への影響を確認**
  - **旧名→新名マッピングをPR内で説明**
  - 必要に応じて **旧名をaliasとして一定期間保持（非推奨化）**

---

## ✅ 作業ログ・レビューの扱い
- ClaudeCodeが自動で修正を加えた場合でも、**PRを通して変更履歴を残す**。
- アルゴリズム・設計の変更を伴う場合、可能であれば**図やサンプルコードで補足説明**を添える。
- **PR内で他の開発者が追える形で変更を言語化することを重視**する。

---

## 📐 実装ルール
### ✅ 構造方針
- GUIと処理ロジック（字幕抽出/整形/翻訳など）は**明確に分離**する。
- OCRエンジンや翻訳APIは **Strategyパターン/Adapterパターン**で差し替え可能に実装する。
- パス・ファイル操作はOS差異に耐えるよう `pathlib` を使用する。

### ✅ UI要件
- 非エンジニアでも操作しやすいよう、**直感的なボタン・ショートカット・入力制限**を備える。
- 字幕の編集は **表形式のテーブルUI（字幕テーブル）** にて提供。
- 字幕行を選択 → 動画プレビューがその時間帯を再生するよう同期。

### ✅ 機能フェーズ（v1.0）
- **字幕抽出（下段固定）**：OpenCVでサンプリング → PaddleOCR → 類似文結合 → SRT出力。
- **字幕編集**：開始/終了/本文をテーブルで編集可。
- **プレビュー同期**：動画再生とテーブル選択の同期。
- **CSVエクスポート/インポート**による外部翻訳支援（GAS用）
- **QCチェック**（行長、行数、重複、時間矛盾など）
- **出力**：日本語/多言語SRTファイル、またはCSV。

---

## 📁 出力ファイル規則
- 日本語SRT: `{basename}.ja.srt`
- 翻訳SRT: `{basename}.{lang}.srt`（例: vlog001.en.srt）
- CSVエクスポート: `subs/{basename}_ja_export.csv`
- 翻訳CSVインポート: `subs/{basename}_translated.csv`
- プロジェクト保存: `.subproj`（JSON形式）

---

## 🔡 翻訳ルール
- 翻訳プロバイダは以下から選択式（翻訳設定画面で切替）
  - Google Cloud Translation v3（Glossary利用可）
  - DeepL API
  - 無し（CSVエクスポート→GAS連携）
- アラビア語など**右から左（RTL）言語はBidi整形をオプションで有効化**
- 未翻訳項目・ブランクの自動検出／アラート表示を行う

---

## 📋 QCチェック仕様
- **行長チェック**：1行42文字以内、最大2行
- **時間矛盾**：開始≧終了 の場合は即エラー
- **重複チェック**：近接で同じ字幕内容が複数ある場合は警告
- **短すぎる表示**：1秒以下など、視認できない秒数は警告

---

## 🧪 テスト用サンプル要件
- 白縁の日本語字幕が下部に焼き付けされた.mp4ファイル（音声なし）
- 短い字幕（1秒未満）や同一字幕の繰り返しを含む
- 出力SRTのタイムコードが**実時間と整合していること**
- アラビア語字幕のSRT整形が**正しくBidi表示**されること（右寄せ）

---

## 📦 配布ポリシー
- PyInstallerにて以下の形式で出力する：
  - macOS: `.app`
  - Windows: `.exe`
  - Linux: `.AppImage` or `.run`
- **PaddleOCRモデルを組み込み**：初回起動時のダウンロード待機を廃止し、即座に利用可能
- オフライン環境でも完全に動作する設計
- 配布ファイルサイズ：約260MB（モデル166MB + アプリ本体94MB）

---

## ❗ ClaudeCodeへの注意喚起
- 初期リリース（v1.0）は**動作重視：OCR→編集→保存までが確実に動くこと**を優先。
- 翻訳・自動検出・Glossaryなどは**段階的に対応（v1.1以降）**。
- 仕様変更・機能追加・リファクタリング前には、**必ず `字幕OCR翻訳アプリ 実装仕様（ClaudeCode向け）` を参照・更新して整合性を保つこと**。

---

## 🧪 テストファイル配置ルール

### ✅ テストディレクトリ構造
```
tests/
├── unit/                    # 単体テスト
│   ├── extractor/          # 字幕抽出関連のテスト
│   ├── format/             # フォーマット関連のテスト
│   └── test_*.py           # その他の単体テスト
├── ui/                     # UIテスト
│   └── test_*.py           # 画面・操作関連のテスト
├── integration/            # 統合テスト
│   └── test_*.py           # エンドツーエンドテスト
└── fixtures/               # テストデータ
    └── *.mp4, *.srt など
```

### ✅ テストファイル命名規則
- **単体テスト**: `test_{機能名}.py` (例: `test_srt_multiline.py`)
- **UIテスト**: `test_{画面名}_{機能}.py` (例: `test_table_multiline_display.py`)
- **統合テスト**: `test_{処理名}_integration.py`

### ⚠️ 禁止事項
- **プロジェクトルートにテストファイルを配置することは禁止**
- 一時的なテスト・デバッグファイルは作業完了後に適切なディレクトリに移動または削除
- `test_*.py`, `debug_*.py` ファイルをルートに残さない

---

## 🔚 補足
- **AI署名完全禁止**：コミットメッセージ・文章・コメントにClaude Code、Claude、AI生成、Co-Authored-By等の記述を絶対に含めない。
- CLI版・Web版展開はこのGUI版が完成後に議論。

---

不明点や例外的な対応が必要な場合は、開発前に必ず確認を入れること。

