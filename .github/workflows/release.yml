name: Automated Release

on:
  push:
    tags:
      - 'v*.*.*'  # Semantic versioning tags (v1.0.0, v1.0.1, etc.)

  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create as draft'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  validate-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      is_draft: ${{ steps.version.outputs.is_draft }}

    steps:
    - uses: actions/checkout@v4

    - name: Determine release parameters
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          IS_DRAFT="${{ github.event.inputs.draft }}"
        else
          VERSION="${{ github.ref_name }}"
          # Pre-release if version contains alpha, beta, rc
          if [[ $VERSION =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE=true
          else
            IS_PRERELEASE=false
          fi
          IS_DRAFT=false
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT

        echo "Release Version: $VERSION"
        echo "Pre-release: $IS_PRERELEASE"
        echo "Draft: $IS_DRAFT"

    - name: Validate version format
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
          echo "âŒ Invalid version format: $VERSION"
          echo "Expected format: v1.0.0 or v1.0.0-beta1"
          exit 1
        fi
        echo "âœ… Version format is valid: $VERSION"

  build-all-platforms:
    needs: validate-release
    uses: ./.github/workflows/build-binaries.yml
    with:
      tag_name: ${{ needs.validate-release.outputs.version }}

  create-changelog:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.changelog }}

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for changelog

    - name: Generate changelog
      id: changelog
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"

        # Get previous tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

        if [ -z "$PREVIOUS_TAG" ]; then
          echo "First release - no previous tag found"
          CHANGELOG="åˆå›ãƒªãƒªãƒ¼ã‚¹"
        else
          echo "Generating changelog from $PREVIOUS_TAG to $VERSION"

          # Generate commit-based changelog
          CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- (feat|fix|docs|refactor|perf|test|chore):" | head -20)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- ãƒã‚°ä¿®æ­£ã¨æ”¹å–„"
          fi
        fi

        # Escape for GitHub output
        CHANGELOG_ESCAPED=$(echo "$CHANGELOG" | sed ':a;N;$!ba;s/\n/%0A/g')
        echo "changelog=$CHANGELOG_ESCAPED" >> $GITHUB_OUTPUT

  publish-release:
    needs: [validate-release, build-all-platforms, create-changelog]
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Download all build artifacts
      uses: actions/download-artifact@v4

    - name: Create comprehensive release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.validate-release.outputs.version }}
        name: VLogå­—å¹•ãƒ„ãƒ¼ãƒ« ${{ needs.validate-release.outputs.version }}
        draft: ${{ needs.validate-release.outputs.is_draft == 'true' }}
        prerelease: ${{ needs.validate-release.outputs.is_prerelease == 'true' }}
        files: |
          vlog-subs-tool-linux/vlog-subs-tool-linux.tar.gz
          vlog-subs-tool-windows/vlog-subs-tool-windows.zip
          vlog-subs-tool-macos/vlog-subs-tool-macos.zip
        body: |
          ## ğŸ¬ VLogå­—å¹•ãƒ„ãƒ¼ãƒ« ${{ needs.validate-release.outputs.version }}

          ### ğŸ“¦ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰

          | ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  | ãƒ•ã‚¡ã‚¤ãƒ« | ã‚µã‚¤ã‚º | èª¬æ˜ |
          |----------------|----------|--------|------|
          | ğŸ§ Linux | `vlog-subs-tool-linux.tar.gz` | ~400MB | Ubuntu 20.04+ å¯¾å¿œ |
          | ğŸªŸ Windows | `vlog-subs-tool-windows.zip` | ~400MB | Windows 10/11 (64bit) |
          | ğŸ macOS | `vlog-subs-tool-macos.zip` | ~400MB | macOS 10.15+ (Intel/Apple Silicon) |

          ### ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

          #### Windows ãƒ¦ãƒ¼ã‚¶ãƒ¼
          1. `vlog-subs-tool-windows.zip` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. é©å½“ãªãƒ•ã‚©ãƒ«ãƒ€ã«å±•é–‹
          3. `vlog-subs-tool.exe` ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯
          4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã¯ã€Œè©³ç´°æƒ…å ±ã€â†’ã€Œå®Ÿè¡Œã€ã§å›é¿

          #### macOS ãƒ¦ãƒ¼ã‚¶ãƒ¼
          1. `vlog-subs-tool-macos.zip` ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. ZIPã‚’å±•é–‹ã—ã¦ `VLogå­—å¹•ãƒ„ãƒ¼ãƒ«.app` ã‚’å–å¾—
          3. å³ã‚¯ãƒªãƒƒã‚¯â†’ã€Œé–‹ãã€ã§åˆå›å®Ÿè¡Œ
          4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Šã§ã€Œé–‹ãã€ã‚’ã‚¯ãƒªãƒƒã‚¯

          #### Linux ãƒ¦ãƒ¼ã‚¶ãƒ¼
          ```bash
          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œ
          tar -xzf vlog-subs-tool-linux.tar.gz
          chmod +x vlog-subs-tool/vlog-subs-tool
          ./vlog-subs-tool/vlog-subs-tool
          ```

          ### ğŸ“ å¤‰æ›´å†…å®¹
          ${{ needs.create-changelog.outputs.changelog }}

          ### ğŸ”§ ã‚·ã‚¹ãƒ†ãƒ è¦ä»¶

          - **Windows**: Windows 10/11 (64bit)
          - **macOS**: macOS 10.15+ (Intel & Apple Silicon)
          - **Linux**: Ubuntu 20.04+ ã¾ãŸã¯åŒç­‰ã®ãƒ‡ã‚£ã‚¹ãƒˆãƒªãƒ“ãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³
          - **ãƒ¡ãƒ¢ãƒª**: 4GB RAMä»¥ä¸Šæ¨å¥¨
          - **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: 1GBä»¥ä¸Šã®ç©ºãå®¹é‡

          ### âš ï¸ é‡è¦ãªæ³¨æ„äº‹é …

          - å®Ÿè¡Œãƒ•ã‚¡ã‚¤ãƒ«ã¯**ãƒ•ã‚©ãƒ«ãƒ€ã”ã¨**ä½¿ç”¨ã—ã¦ãã ã•ã„ï¼ˆå˜ä½“ã§ã®ç§»å‹•ã¯å‹•ä½œã—ã¾ã›ã‚“ï¼‰
          - åˆå›èµ·å‹•æ™‚ã¯ OCR ãƒ¢ãƒ‡ãƒ«ã®æº–å‚™ã§æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
          - ã‚¦ã‚¤ãƒ«ã‚¹å¯¾ç­–ã‚½ãƒ•ãƒˆã§èª¤æ¤œçŸ¥ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ï¼ˆå®‰å…¨ã§ã™ï¼‰
          - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ç’°å¢ƒã§ã‚‚å®Œå…¨å‹•ä½œã—ã¾ã™ï¼ˆOCRå‡¦ç†ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œï¼‰

          ### ğŸ†˜ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

          #### èµ·å‹•ã—ãªã„å ´åˆ
          1. ãƒ•ã‚©ãƒ«ãƒ€å†…ã®ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒå±•é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          2. ã‚¦ã‚¤ãƒ«ã‚¹å¯¾ç­–ã‚½ãƒ•ãƒˆã®é™¤å¤–è¨­å®šã‚’ç¢ºèª
          3. ç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œã‚’è©¦è¡Œ

          #### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å•é¡Œ
          - CPUãŒå¤ã„å ´åˆã¯è¨­å®šã§ã€Œã‚¹ãƒ¬ãƒƒãƒ‰æ•°ã€ã‚’èª¿æ•´
          - ãƒ¡ãƒ¢ãƒªä¸è¶³ã®å ´åˆã¯ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’çµ‚äº†

          ### ğŸ“ ã‚µãƒãƒ¼ãƒˆ

          å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ [Issues](https://github.com/lancelot89/vlog-subs-tool/issues) ã¾ã§ã”å ±å‘Šãã ã•ã„ã€‚

          ---

          **é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç’°å¢ƒ**: Python 3.12, PySide6, PaddleOCR
          **ãƒ“ãƒ«ãƒ‰æ—¥æ™‚**: $(date -u '+%Y-%m-%d %H:%M UTC')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-completion:
    needs: [publish-release, validate-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Release completion summary
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        STATUS="${{ needs.publish-release.result }}"

        if [ "$STATUS" = "success" ]; then
          echo "ğŸ‰ Release $VERSION published successfully!"
          echo "ğŸ“¦ Binaries are available at: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
        else
          echo "âŒ Release $VERSION failed"
          echo "Check the workflow logs for details"
        fi