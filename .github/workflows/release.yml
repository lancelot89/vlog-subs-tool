name: Automated Release

on:
  push:
    tags:
      - 'v*.*.*'  # Semantic versioning tags (v1.0.0, v1.0.1, etc.)

  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean
      draft:
        description: 'Create as draft'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  actions: read

jobs:
  validate-release:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
      is_draft: ${{ steps.version.outputs.is_draft }}

    steps:
    - uses: actions/checkout@v5

    - name: Determine release parameters
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          IS_DRAFT="${{ github.event.inputs.draft }}"
        else
          VERSION="${{ github.ref_name }}"
          # Pre-release if version contains alpha, beta, rc
          if [[ $VERSION =~ (alpha|beta|rc) ]]; then
            IS_PRERELEASE=true
          else
            IS_PRERELEASE=false
          fi
          IS_DRAFT=false
        fi

        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
        echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT

        echo "Release Version: $VERSION"
        echo "Pre-release: $IS_PRERELEASE"
        echo "Draft: $IS_DRAFT"

    - name: Validate version format
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
          echo "❌ Invalid version format: $VERSION"
          echo "Expected format: v1.0.0 or v1.0.0-beta1"
          exit 1
        fi
        echo "✅ Version format is valid: $VERSION"

  build-linux:
    needs: validate-release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          qt6-base-dev \
          libgl1-mesa-dev \
          libxcb-xinerama0 \
          libegl1-mesa-dev \
          libxkbcommon-x11-0 \
          libxcb-icccm4 \
          libxcb-image0 \
          libxcb-keysyms1 \
          libxcb-render-util0 \
          libxcb-xkb1 \
          libfontconfig1 \
          libfreetype6

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Linux binary
      run: |
        export GITHUB_ACTIONS=true
        chmod +x scripts/build_binary.sh
        ./scripts/build_binary.sh linux

    - name: Create Linux archive
      run: |
        cd dist/linux
        tar -czf "vlog-subs-tool-linux.tar.gz" vlog-subs-tool/
        cat > README_Linux.txt << 'EOF'
        VLog字幕ツール Linux版

        使用方法:
        1. tar.gzファイルを展開: tar -xzf vlog-subs-tool-linux.tar.gz
        2. 実行権限を付与: chmod +x vlog-subs-tool/vlog-subs-tool
        3. 実行: ./vlog-subs-tool/vlog-subs-tool

        注意事項:
        - フォルダ内のファイルを削除しないでください
        - 実行ファイルのみを移動すると動作しません
        - Ubuntu 20.04+ または同等のディストリビューションが必要です
        EOF
        tar -czf "vlog-subs-tool-linux.tar.gz" vlog-subs-tool/ README_Linux.txt

    - name: Upload Linux binary
      uses: actions/upload-artifact@v4
      with:
        name: vlog-subs-tool-linux
        path: dist/linux/vlog-subs-tool-linux.tar.gz

  build-windows:
    needs: validate-release
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build Windows binary
      shell: bash
      run: |
        export GITHUB_ACTIONS=true
        chmod +x scripts/build_binary.sh
        ./scripts/build_binary.sh windows

    - name: Create Windows ZIP archive
      shell: pwsh
      run: |
        Set-Location dist/windows

        $readmeContent = "VLog字幕ツール Windows版`n`n使用方法:`n1. ZIPファイルを適当なフォルダに展開`n2. フォルダ内の vlog-subs-tool.exe をダブルクリックして実行`n3. Windows Defenderの警告が出た場合は「詳細情報」→「実行」をクリック`n`n注意事項:`n- フォルダ内のファイルを削除しないでください`n- 実行ファイルのみを移動すると動作しません"
        $readmeContent | Out-File -FilePath "README_Windows.txt" -Encoding UTF8

        Compress-Archive -Path "vlog-subs-tool", "README_Windows.txt" -DestinationPath "vlog-subs-tool-windows.zip" -Force

    - name: Upload Windows binary
      uses: actions/upload-artifact@v4
      with:
        name: vlog-subs-tool-windows
        path: dist/windows/vlog-subs-tool-windows.zip

  build-macos:
    needs: validate-release
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build macOS binary
      run: |
        export GITHUB_ACTIONS=true
        chmod +x scripts/build_binary.sh
        ./scripts/build_binary.sh macos

    - name: Fix macOS app permissions
      run: |
        if [ -d "dist/macos/VLog字幕ツール.app" ]; then
          chmod +x "dist/macos/VLog字幕ツール.app/Contents/MacOS/VLog字幕ツール"
          xattr -cr "dist/macos/VLog字幕ツール.app" || true
        fi

    - name: Create macOS ZIP archive
      run: |
        cd dist/macos
        cat > README_macOS.txt << 'EOF'
        VLog字幕ツール macOS版

        使用方法:
        1. ZIPファイルを展開
        2. VLog字幕ツール.appをアプリケーションフォルダに移動（推奨）
        3. 右クリックで「開く」を選択（初回のみ）
        4. セキュリティ警告で「開く」をクリック
        5. 以降はダブルクリックで起動可能

        注意事項:
        - .appファイルは単一のファイルです
        - macOS 10.15 (Catalina) 以上が必要です
        EOF
        zip -r "vlog-subs-tool-macos.zip" "VLog字幕ツール.app" README_macOS.txt

    - name: Upload macOS binary
      uses: actions/upload-artifact@v4
      with:
        name: vlog-subs-tool-macos
        path: dist/macos/vlog-subs-tool-macos.zip

  create-release:
    needs: [validate-release, build-linux, build-windows, build-macos]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Generate changelog
      id: changelog
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"

        # Get previous tag
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")

        if [ -z "$PREVIOUS_TAG" ]; then
          echo "First release - no previous tag found"
          CHANGELOG="初回リリース"
        else
          echo "Generating changelog from $PREVIOUS_TAG to $VERSION"

          # Generate commit-based changelog
          CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD | grep -E "^- (feat|fix|docs|refactor|perf|test|chore):" | head -20)

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- バグ修正と改善"
          fi
        fi

        # Escape for GitHub output
        CHANGELOG_ESCAPED=$(echo "$CHANGELOG" | sed ':a;N;$!ba;s/\n/%0A/g')
        echo "changelog=$CHANGELOG_ESCAPED" >> $GITHUB_OUTPUT

    - name: Download all artifacts
      uses: actions/download-artifact@v5

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.validate-release.outputs.version }}
        name: VLog字幕ツール ${{ needs.validate-release.outputs.version }}
        draft: ${{ needs.validate-release.outputs.is_draft == 'true' }}
        prerelease: ${{ needs.validate-release.outputs.is_prerelease == 'true' }}
        files: |
          vlog-subs-tool-linux/vlog-subs-tool-linux.tar.gz
          vlog-subs-tool-windows/vlog-subs-tool-windows.zip
          vlog-subs-tool-macos/vlog-subs-tool-macos.zip
        body: |
          ## 🎬 VLog字幕ツール ${{ needs.validate-release.outputs.version }}

          ### 📦 ダウンロード

          | プラットフォーム | ファイル | サイズ | 説明 |
          |----------------|----------|--------|------|
          | 🐧 Linux | `vlog-subs-tool-linux.tar.gz` | ~400MB | Ubuntu 20.04+ 対応 |
          | 🪟 Windows | `vlog-subs-tool-windows.zip` | ~400MB | Windows 10/11 (64bit) |
          | 🍎 macOS | `vlog-subs-tool-macos.zip` | ~400MB | macOS 10.15+ (Intel/Apple Silicon) |

          ### 🚀 クイックスタート

          #### Windows ユーザー
          1. `vlog-subs-tool-windows.zip` をダウンロード
          2. 適当なフォルダに展開
          3. `vlog-subs-tool.exe` をダブルクリック
          4. セキュリティ警告は「詳細情報」→「実行」で回避

          #### macOS ユーザー
          1. `vlog-subs-tool-macos.zip` をダウンロード
          2. ZIPを展開して `VLog字幕ツール.app` を取得
          3. 右クリック→「開く」で初回実行
          4. セキュリティ警告で「開く」をクリック

          #### Linux ユーザー
          ```bash
          # ダウンロード後
          tar -xzf vlog-subs-tool-linux.tar.gz
          chmod +x vlog-subs-tool/vlog-subs-tool
          ./vlog-subs-tool/vlog-subs-tool
          ```

          ### 📝 変更内容
          ${{ steps.changelog.outputs.changelog }}

          ### 🔧 システム要件

          - **Windows**: Windows 10/11 (64bit)
          - **macOS**: macOS 10.15+ (Intel & Apple Silicon)
          - **Linux**: Ubuntu 20.04+ または同等のディストリビューション
          - **メモリ**: 4GB RAM以上推奨
          - **ストレージ**: 1GB以上の空き容量

          ### ⚠️ 重要な注意事項

          - 実行ファイルは**フォルダごと**使用してください（単体での移動は動作しません）
          - 初回起動時は OCR モデルの準備で時間がかかる場合があります
          - ウイルス対策ソフトで誤検知される場合があります（安全です）
          - オフライン環境でも完全動作します（OCR処理はローカルで実行）

          ### 🆘 トラブルシューティング

          #### 起動しない場合
          1. フォルダ内のすべてのファイルが展開されているか確認
          2. ウイルス対策ソフトの除外設定を確認
          3. 管理者権限で実行を試行

          #### パフォーマンス問題
          - CPUが古い場合は設定で「スレッド数」を調整
          - メモリ不足の場合は他のアプリケーションを終了

          ### 📞 サポート

          問題が発生した場合は [Issues](https://github.com/lancelot89/vlog-subs-tool/issues) までご報告ください。

          ---

          **開発・テスト環境**: Python 3.12, PySide6, PaddleOCR
          **ビルド日時**: $(date -u '+%Y-%m-%d %H:%M UTC')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  notify-completion:
    needs: [create-release, validate-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
    - name: Release completion summary
      run: |
        VERSION="${{ needs.validate-release.outputs.version }}"
        STATUS="${{ needs.create-release.result }}"

        if [ "$STATUS" = "success" ]; then
          echo "🎉 Release $VERSION published successfully!"
          echo "📦 Binaries are available at: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
        else
          echo "❌ Release $VERSION failed"
          echo "Check the workflow logs for details"
        fi